<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Full Feature: Login, Capture, and Crop</title>
<style>
  body, html {
    height: 100%;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .container {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .active {
    display: flex;
  }
  canvas, video {
    border: 1px solid #ddd;
    margin-top: 20px;
  }
  #imageLoader {
    display: none;
  }
  .button {
    margin-top: 10px;
  }
</style>
</head>
<body>

<div id="loginContainer" class="container active">
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button class="button" onclick="login()">Login</button>
</div>

<div id="captureContainer" class="container">
  <video id="video" width="640" height="480" autoplay></video>
  <button class="button" id="snap">Capture</button>
  <button class="button" onclick="document.getElementById('imageLoader').click();">Select Photo</button>
  <input type="file" id="imageLoader" accept="image/*">
  <canvas id="canvas" width="640" height="480"></canvas>
  <button class="button" id="confirmCrop">Confirm Crop</button>
</div>

<script>
  let currentUser = '';
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const imageLoader = document.getElementById('imageLoader');
  let image = new Image();
  let cropRect = { x: 150, y: 100, width: 340, height: 280 };
  let dragStart = null;
  let dragging = false;
  let resizing = false;
  let currentHandle = null;
  const handleSize = 10;

  function login() {
    // Here, implement your actual login logic
    currentUser = document.getElementById('username').value;
    if (currentUser) { // Simplified check
      document.getElementById('loginContainer').classList.remove('active');
      document.getElementById('captureContainer').classList.add('active');
      startCamera();
    } else {
      alert('Please enter username');
    }
  }

  function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(function(stream) {
        video.srcObject = stream;
      }).catch(function(error) {
        console.error("Unable to access camera: ", error);
      });
  }

  document.getElementById('snap').addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    video.srcObject.getTracks().forEach(track => track.stop()); // Stop the camera
    drawCropRect();
  });

  imageLoader.addEventListener('change', function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(event) {
      image.onload = function() {
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
        drawCropRect();
      };
      image.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });

  function drawCropRect() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 2;
    ctx.strokeRect(cropRect.x, cropRect.y, cropRect.width, cropRect.height);

    // Draw resize handles
    const handles = getHandles();
    handles.forEach(handle => {
      ctx.fillStyle = 'blue';
      ctx.fillRect(handle.x - handleSize / 2, handle.y - handleSize / 2, handleSize, handleSize);
    });
  }

  function getHandles() {
    return [
      { x: cropRect.x, y: cropRect.y }, // Top-left
      { x: cropRect.x + cropRect.width, y: cropRect.y }, // Top-right
      { x: cropRect.x, y: cropRect.y + cropRect.height }, // Bottom-left
      { x: cropRect.x + cropRect.width, y: cropRect.y + cropRect.height } // Bottom-right
    ];
  }

  canvas.addEventListener('mousedown', function(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    dragStart = { x, y };

    const handles = getHandles();
    currentHandle = handles.findIndex(handle =>
      x >= handle.x - handleSize / 2 && x <= handle.x + handleSize / 2 &&
      y >= handle.y - handleSize / 2 && y <= handle.y + handleSize / 2
    );

    if (currentHandle !== -1) {
      resizing = true;
    } else if (x >= cropRect.x && x <= cropRect.x + cropRect.width &&
               y >= cropRect.y && y <= cropRect.y + cropRect.height) {
      dragging = true;
    }
  });

  canvas.addEventListener('mousemove', function(e) {
    if (resizing) {
      resizeCropArea(e);
    } else if (dragging) {
      moveCropArea(e);
    }
  });

  canvas.addEventListener('mouseup', function() {
    dragging = false;
    resizing = false;
  });

  function moveCropArea(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const dx = x - dragStart.x;
    const dy = y - dragStart.y;

    cropRect.x += dx;
    cropRect.y += dy;

    dragStart = { x, y };
    drawCropRect();
  }

  function resizeCropArea(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const dx = x - dragStart.x;
    const dy = y - dragStart.y;

    switch (currentHandle) {
      case 0: // Top-left
        cropRect.x += dx;
        cropRect.width -= dx;
        cropRect.y += dy;
        cropRect.height -= dy;
        break;
      case 1: // Top-right
        cropRect.width += dx;
        cropRect.y += dy;
        cropRect.height -= dy;
        break;
      case 2: // Bottom-left
        cropRect.x += dx;
        cropRect.width -= dx;
        cropRect.height += dy;
        break;
      case 3: // Bottom-right
        cropRect.width += dx;
        cropRect.height += dy;
        break;
    }

    dragStart = { x, y };
    drawCropRect();
  }

  // Add more code here for further functionalities, such as confirming the crop
</script>

</body>
</html>
